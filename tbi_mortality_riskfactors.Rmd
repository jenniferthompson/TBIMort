---
title: Baseline and In-Hospital Risk Factors for Mortality and Other Outcomes among
  TBI Patients
author: 'Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD'
date: '`r format(Sys.time(), "%B %d %Y")`'
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 2
abstract: The following analyses examine baseline and in-hospital risk factors for
  in-hospital mortality, in-hospital and discharge characteristics, and long-term
  mortality among a cohort of traumatic brain injury (TBI) patients with at least
  one day in the ICU.
---

```{r knitrsetup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r setup, message = FALSE, results='hide'}
## Make indentation for Markdown tables easier
space.3 <- paste(rep("&nbsp;", 3), collapse = '')
space.6 <- paste(rep("&nbsp;", 6), collapse = '')
space.9 <- paste(rep("&nbsp;", 9), collapse = '')

## Load libraries and original analysis data sets
library(captioner)
library(tidyverse)
library(pander)
library(rms)

## Set up figure, table numbering
table_nums <- captioner(prefix = 'Table')
table_nums(name = 'consort', caption = 'Cohort Inclusion and Exclusion')
table_nums(name = 'descstats_oneobs', caption = 'Baseline, In-Hospital, & Discharge Characteristics')
table_nums(name = 'descstats_daily', caption = 'Daily In-Hospital Characteristics')

## Load analysis data sets
load('AnalysisData/tbi_datasets.Rdata')

## -- Create analysis data sets including only ICU patients ----------------------------------------
## Patients with an ICU LOS of at least 1 day
icu.pts <- unique(filter(tbi.oneobs, !is.na(icu.los) & icu.los > 0)$mrn)

## Filter daily data
tbi.daily.icu <- filter(tbi.daily, mrn %in% icu.pts)

## How many patients who would otherwise be included had no daily EMR data?
icu.nodaily.pts <- setdiff(icu.pts, unique(tbi.daily.icu$mrn))

## MRNs of all patients included in final analyses (>=1 ICU day, demographic + daily data)
pts.inc <- intersect(icu.pts, unique(tbi.daily.icu$mrn))

## Subset tbi.oneobs to only include pts.inc
tbi.oneobs.icu <- filter(tbi.oneobs, mrn %in% pts.inc)

```

# Cohort Description
We originally collected electronic medical record data for `r length(unique(tbi.oneobs$mrn))`
patients aged 16 years or older admitted to VUMC between August 2006 and July 2012 with traumatic
brain injury (TBI) requiring hospitalization. TBI was classified based on ICD-9 diagnostic codes,
and includes concussion without intracranial hemorrhage. Code used to create analysis data sets from
raw EMR data can be found
[here](https://github.com/jenniferthompson/TBIMort/blob/master/tbimortality_datamgmt.R).

For these analyses, we focused on patients admitted to the ICU.
`r table_nums('consort', display = 'cite')` describes how patients were included and excluded from
analyses.

```{r createconsorttable}
## -- Calculate Ns for each group of patients included/excluded ------------------------------------
## Original number of TBI patients
n.alltbi <- length(unique(tbi.oneobs$mrn))

## Had ICU LOS >= 1 day?
n.nolos <- sum(is.na(tbi.oneobs$icu.los))
n.noicu <- with(tbi.oneobs, sum(!is.na(icu.los) & icu.los == 0))
n.icu <- length(icu.pts)

## No daily data vs included in main analyses (meaning, at least one day of daily data)
n.nodaily <- length(icu.nodaily.pts)
n.included.main <- length(pts.inc)

## Died vs survived hospital stay; survivors will be included in FIM model
n.diedinhosp <- with(tbi.oneobs.icu, sum(!is.na(hosp.death) & hosp.death == 'Yes'))
n.survivors <- with(tbi.oneobs.icu, sum(!is.na(hosp.death) & hosp.death == 'No'))

## Create CONSORT table
consort.table <- data.frame(Patients = c('All TBI Patients',
                                         paste0(space.3, 'Missing ICU LOS data'),
                                         paste0(space.3, '0 days in ICU'),
                                         paste0(space.3, '>=1 day in ICU'),
                                         paste0(space.6, 'Missing daily EMR data'),
                                         paste0('**', space.6, 'Included in main analyses**'),
                                         paste0(space.9, 'Died in hospital'),
                                         paste0(space.9, 'Survived hospital stay (FIM model)')),
                            N = c(n.alltbi, n.nolos, n.noicu, n.icu, n.nodaily,
                                  paste0('**', n.included.main, '**'), n.diedinhosp, n.survivors))

```

#### `r table_nums('consort')`
```{r printconsorttable, results = 'asis'}
pander(consort.table, justify = c('left', 'right'))

```
#### `r table_nums('descstats_oneobs')`
```{r printdescstatsoneobs, results = 'markup'}
summaryM(age + gender + race + insurance.code + iss + cpr.yn + pt.marshall + pt.cerebral +
           pt.epidural + pt.injury + vent.days + days.mental + days.del + days.coma + dcfd.14 +
           icu.los + los + hosp.death + disposition.coded + fim.total + died.3yr ~ 1,
         data = tbi.oneobs.icu)

```

#### `r table_nums('descstats_daily')`
```{r printdescstatsdaily, results = 'markup'}
summaryM(mental.status + max.motor.imp + pupil.react.imp + min.glucose.imp + min.hemoglobin.imp +
           min.sodium.imp + max.icp.imp + max.icp.dich + sofa.nanormal.imp + tot.benzo +
           tot.opioid + tot.propofol + tot.dex + tot.antipsyc + tot.betablock + tot.pento +
           tot.clonid + units.cryo + units.plasma + units.platelets + units.prbc ~ 1,
         data = tbi.daily.icu)

```