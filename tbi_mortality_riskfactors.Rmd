---
title: Baseline and In-Hospital Risk Factors for Mortality and Other Outcomes among
  TBI Patients
author: 'Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD'
date: '`r format(Sys.time(), "%B %d %Y")`'
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 2
abstract: The following analyses examine baseline and in-hospital risk factors for
  in-hospital mortality, in-hospital and discharge characteristics, and long-term
  mortality among a cohort of traumatic brain injury (TBI) patients with at least
  one day in the ICU.
---

```{r knitr_setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results='hide')
options(width = 200)
```

```{r setup, message = FALSE, results='hide'}
## Make indentation for Markdown tables easier
space.3 <- paste(rep("&nbsp;", 3), collapse = '')
space.6 <- paste(rep("&nbsp;", 6), collapse = '')
space.9 <- paste(rep("&nbsp;", 9), collapse = '')
space.12 <- paste(rep("&nbsp;", 12), collapse = '')
space.15 <- paste(rep("&nbsp;", 15), collapse = '')

## Load libraries
library(captioner)
library(tidyverse)
library(pander)
library(rms)

## -- Functions for general use --------------------------------------------------------------------
## Source function for creating time-varying data sets for Cox models
source('tbi_timevarying.R')

## Source function for getting results from rms model fits
source('/home/thomps23/R/rmsHelpers/model_results.R')

## Calculate what % (N) of records are missing in a given data set
## For a single variable: returns a vector with N, %, and formatted string including both
missingVariable <- function(vname, df){
  nmiss <- sum(is.na(df[,vname]))
  pctmiss <- (nmiss / nrow(df))*100
  pctmiss <- ifelse(pctmiss < 1 & nmiss > 0, round(pctmiss, 2), round(pctmiss, 0))
  
  c('nmiss' = nmiss,
    'pctmiss' = pctmiss,
    '% (N)' = paste0(pctmiss, '% (', format(nmiss, big.mark = ','), ')'))
}

## For a data frame: returns a data frame with variable name, N, %, and formatted strings
missingInDataFrame <- function(df, ## data frame for which to get missingness
                               ignore.vars = c('mrn', 'event', 'study.day')){
                               ## ignore these variables (typically, ID and time variables)
  tmp <- as.data.frame(do.call(rbind,
                               lapply(setdiff(names(df), ignore.vars), FUN = function(vname){
                                 c("Variable" = vname, missingVariable(vname, df))
                               })))
  tmp$nmiss <- as.numeric(as.character(tmp$nmiss))
  tmp$pctmiss <- as.numeric(as.character(tmp$pctmiss))
  return(tmp)
}


## -- Set up figure, table numbering using the captioner package -----------------------------------
table_nums <- captioner(prefix = 'Table')
table_nums(name = 'consort', caption = 'Cohort Inclusion and Exclusion')
table_nums(name = 'descstats_oneobs',
           caption = 'Baseline, In-Hospital, & Discharge Characteristics')
table_nums(name = 'descstats_daily', caption = 'Daily In-Hospital Characteristics')
table_nums(name = 'clinical_imputation',
           caption = 'Missingness among Daily Variables Imputed by Rule')
table_nums(name = 'mort_inhosp_missing_baseline',
           caption = 'Patients Excluded from In-Hospital Mortality Model due to Missing Baseline Data')
table_nums(name = 'mort_inhosp_missing_daily',
           caption = 'Patient-Days Requiring Imputation for In-Hospital Mortality Model')

table_nums(name = 'package_info', caption = 'R Packages Loaded')

figure_nums <- captioner(prefix = 'Figure')
figure_nums(name = 'dailydrughist',
            caption = 'Daily Drug Doses and Blood Product among Analysis Cohort')
figure_nums(name = 'mort_inhosp_zph', 'Proportional Hazards Assumption')

## -- Load analysis data sets, additional data management ------------------------------------------
load('AnalysisData/tbi_datasets.Rdata')

## Shorten long categories of factor variables
levels(tbi.oneobs$cpr.yn) <- c('No', 'Yes')
levels(tbi.oneobs$pt.marshall) <- gsub('Marshall Class ', '', levels(tbi.oneobs$pt.marshall))

## New variable with some levels of discharge disposition combined d/t small N
tbi.oneobs$disposition.comb <-
  with(tbi.oneobs, factor(ifelse(disposition.coded == 'Discharged home', 1,
                          ifelse(disposition.coded == 'Death in hospital', 2,
                          ifelse(disposition.coded == 'Hospice', 3,
                          ifelse(disposition.coded == 'Inpatient rehab', 4,
                          ifelse(disposition.coded == 'Jail or prison', 5,
                          ifelse(disposition.coded %in%
                                   c('LTAC',
                                     'Nursing care (including SNF and nursing home)',
                                     'Transfer to other hospital'), 6,
                          ifelse(disposition.coded == 'Psych unit', 7, NA))))))),
                          levels = 1:7,
                          labels = c('Discharged home',
                                     'Death in hospital',
                                     'Hospice',
                                     'Inpatient rehab',
                                     'Jail or prison',
                                     'Long-term care',
                                     'Psych unit')))

## Combine non-RBC blood products into a dichotomous received/not received variable
tbi.daily$any.plasmaplt <-
  factor(ifelse(rowSums(tbi.daily[,c(paste0('units.', c('cryo', 'plasma', 'platelets')))] > 0) > 0,
                2, 1),
         levels = 1:2, labels = c('None', 'At least one'))
label(tbi.daily$any.plasmaplt) <- '24h plasma and/or platelets'

## Dichotomous variables for PRBC, all drugs
any.drug <- function(x){ factor(ifelse(x == 0, 1, 2), levels = 1:2, labels = c('None', 'Some')) }

tbi.daily <- tbi.daily %>%
  mutate(any.prbc = factor(ifelse(units.prbc > 0, 2, 1),
                           levels = 1:2, labels = c('None', 'At least some')),
         any.antipsyc = any.drug(tot.antipsyc),
         any.benzo = any.drug(tot.benzo),
         any.betablock = any.drug(tot.betablock),
         any.clonid = any.drug(tot.clonid),
         any.dex = any.drug(tot.dex),
         any.opioid = any.drug(tot.opioid),
         any.pento = any.drug(tot.pento),
         any.propofol = any.drug(tot.propofol),
         ## Combined dichotomous variable for alpha-2 agonists (dex/clonidine)
         any.alpha2 = factor(as.numeric(any.dex == 'Some' | any.clonid == 'Some') + 1,
                             levels = 1:2, labels = c('Neither', 'One or both')))

label(tbi.daily$any.prbc) <- '24h PRBC'
label(tbi.daily$any.antipsyc) <- '24h antipsychotics, y/n'
label(tbi.daily$any.benzo) <- '24h benzodiazepines, y/n'
label(tbi.daily$any.betablock) <- '24h beta-blockers, y/n'
label(tbi.daily$any.clonid) <- '24h clonidine, y/n'
label(tbi.daily$any.dex) <- '24h dexmedetomidine, y/n'
label(tbi.daily$any.opioid) <- '24h opioids, y/n'
label(tbi.daily$any.pento) <- '24h pentobarbital, y/n'
label(tbi.daily$any.propofol) <- '24h propofol, y/n'
label(tbi.daily$any.alpha2) <- '24h alpha-2 agonists (clonidine/dex)'

## Shorten factor levels
levels(tbi.daily$max.icp.dich) <- c('Normal', 'Abnormal')

## -- Create analysis data sets including only ICU patients ----------------------------------------
## Patients with an ICU LOS of at least 1 day, admitted with blunt trauma
icu.pts <- unique(filter(tbi.oneobs, !is.na(icu.los) & icu.los > 0 & pt.injury == 'Blunt')$mrn)

## Filter daily data
tbi.daily.icu <- filter(tbi.daily, mrn %in% icu.pts)

## How many patients who would otherwise be included had no daily EMR data?
icu.nodaily.pts <- setdiff(icu.pts, unique(tbi.daily.icu$mrn))

## MRNs of all patients included in final analyses (>=1 ICU day, demographic + daily data)
pts.inc <- intersect(icu.pts, unique(tbi.daily.icu$mrn))

## Subset tbi.oneobs to only include pts.inc
tbi.oneobs.icu <- filter(tbi.oneobs, mrn %in% pts.inc)

```

# Cohort Description
We originally collected electronic medical record data for `r length(unique(tbi.oneobs$mrn))`
patients aged 16 years or older admitted to VUMC between August 2006 and July 2012 with traumatic
brain injury (TBI) requiring hospitalization. TBI was classified based on ICD-9 diagnostic codes,
and includes concussion without intracranial hemorrhage. Code used to create analysis data sets from
raw EMR data can be found
[here](https://github.com/jenniferthompson/TBIMort/blob/master/tbimortality_datamgmt.R).

For these analyses, we focused on patients admitted to the ICU and who had blunt (vs penetrating)
trauma.

## CONSORT Information
`r table_nums('consort', display = 'cite')` describes how patients were included and
excluded from our broad cohort, with requirements for inclusion in **bold**. Patients included in
each specific analysis will be described in each section, beginning with this group of
`r length(pts.inc)`.

```{r create_consort_table}
## -- Calculate Ns for each group of patients included/excluded ------------------------------------
## Original number of TBI patients
n.alltbi <- length(unique(tbi.oneobs$mrn))

## Had penetrating vs blunt trauma
n.injuryna <- sum(tbi.oneobs$pt.injury == 'Missing', na.rm = TRUE)
n.penetrating <- sum(tbi.oneobs$pt.injury == 'Penetrating', na.rm = TRUE)
n.blunt <- sum(tbi.oneobs$pt.injury == 'Blunt', na.rm = TRUE)

## Blunt injury and had ICU LOS >= 1 day?
n.nolos <- sum(is.na(subset(tbi.oneobs, pt.injury == 'Blunt')$icu.los))
n.noicu <- with(subset(tbi.oneobs, pt.injury == 'Blunt'), sum(!is.na(icu.los) & icu.los == 0))
n.icu <- length(icu.pts)

## No daily data vs included in main analyses (meaning, at least one day of daily data)
n.nodaily <- length(icu.nodaily.pts)
n.included.main <- length(pts.inc)

## Create CONSORT table
consort.table <- data.frame(Patients = c('All TBI Patients',
                                         paste0(space.3, 'Missing injury type'),
                                         paste0(space.3, 'Penetrating injury'),
                                         paste0(space.3, '**Blunt injury**'),
                                         paste0(space.6, 'Missing ICU LOS data'),
                                         paste0(space.6, '0 days in ICU'),
                                         paste0(space.6, '**>=1 day in ICU**'),
                                         paste0(space.9, 'Missing daily EMR data'),
                                         paste0(space.9, '**Eligible for inclusion**')),
                            N = c(n.alltbi, n.injuryna, n.penetrating, paste0('**', n.blunt, '**'),
                                  n.nolos, n.noicu, paste0('**', n.icu, '**'), n.nodaily,
                                  paste0('**', n.included.main, '**')))

```

#### `r table_nums('consort')`
```{r print_consort_table, results = 'asis'}
pandoc.table(consort.table, justify = c('left', 'right'))

```

## Descriptive Statistics for Baseline, Summary and Daily Characteristics
#### `r table_nums('descstats_oneobs')`
```{r print_descstats_oneobs, results = 'markup'}
summaryM(age + gender + race + insurance.code + iss + cpr.yn + pt.marshall + pt.cerebral +
           pt.epidural + pt.injury + vent.days + days.mental + days.del + days.coma + dcfd.14 +
           icu.los + los + hosp.death + disposition.coded + fim.total + died.3yr ~ 1,
         data = tbi.oneobs.icu)

```

#### `r table_nums('descstats_daily')`
```{r print_descstats_daily, results = 'markup'}
summaryM(mental.status + max.motor.imp + pupil.react.imp + min.glucose.imp + min.hemoglobin.imp +
           min.sodium.imp + max.icp.imp + max.icp.dich + sofa.nanormal.imp + any.benzo + tot.benzo +
           any.opioid + tot.opioid + any.propofol + tot.propofol + any.dex + tot.dex + any.clonid +
           tot.clonid + any.alpha2 + any.antipsyc + tot.antipsyc + any.betablock + tot.betablock +
           any.pento + tot.pento + any.plasmaplt + units.cryo + units.plasma + units.platelets +
           any.prbc + units.prbc ~ 1,
         data = tbi.daily.icu)

```

## Exploratory Analyses
```{r exploratory_datamgmt}
## -- Describe daily drug, blood product doses -----------------------------------------------------
## Raw doses for histograms
daily.drugs <- tbi.daily.icu %>%
  select(mrn, study.day, tot.benzo.cube, tot.opioid.cube, tot.propofol.cube, tot.dex.cube,
         tot.antipsyc.cube, tot.betablock.cube, tot.pento.cube, tot.clonid.cube, units.cryo,
         units.plasma, units.platelets, units.prbc) %>%
  gather(key = drug.or.product, value = amount, tot.benzo.cube:units.prbc)

## Summary statistics for annotation
daily.drugs.summary <- daily.drugs %>%
  group_by(drug.or.product) %>%
  summarise(n.zero = sum(amount == 0),
            pct.zero = round(mean(amount == 0)*100, digits = 1),
            min.nonzero = round(min(amount[amount != 0]), 2),
            med.nonzero = round(median(amount[amount != 0]), 2),
            max.nonzero = round(max(amount[amount != 0]), 2)) %>%
  mutate(results.str = paste0('% (N) Zero: ', pct.zero, '% (', n.zero,
                              ')\nMedian (Range) among Non-Zero:\n',
                              med.nonzero, ' (', min.nonzero, ', ', max.nonzero, ')'))

```

To guide our choice of covariates in models with time-varying covariates, we plotted histograms and detailed summary statistics for all drug doses and blood products given on a daily basis (`r figure_nums('dailydrughist', display = 'cite')`).

#### `r figure_nums('dailydrughist')`
```{r print_exploratory, results = 'asis', fig.width=7, fig.height = 10}
ggplot(data = daily.drugs, aes(x = amount)) +
  facet_wrap(~ drug.or.product, ncol = 2, scales = 'free_x') +
  geom_histogram() +
  geom_text(data = daily.drugs.summary, aes(label = results.str, x = max.nonzero),
            y = 30000, hjust = 1, vjust = 1, size = 3)

```

# Clinical Imputation Rules for Missing Data
As this is medical record data, there is a large amount of missingness: labs are not ordered unless
there is reason to order them, for example. We developed a set of clinical imputation rules to deal
with much of this missingness among our covariates.

Several daily variables were imputed by using the closest value within two days before or after the
missing value. If two values equidistant from the missing day were available, preference was given
to the earlier value. `r table_nums("clinical_imputation", display = 'cite')` shows the number of records originally missing for each of these variables; the number successfully imputed using this two-day rule; and the number which remain missing after the two-day rule was implemented.

```{r clinical_imp}
## -- For each covariate imputed via two-day rule, get N missing in original data, -----------------
## -- N successfully imputed, and N still missing after imputation ---------------------------------
clinical.imp.covars <- c('max.motor', 'pupil.react', 'min.glucose', 'min.hemoglobin', 'min.sodium',
                         'sofa.resp', 'sofa.cns', 'sofa.cv', 'sofa.coag', 'sofa.renal')

clinical.imp.npct.missing <- do.call(rbind,
                                     lapply(clinical.imp.covars, FUN = function(vname){
  vname.imp <- paste0(vname, '.imp')
  
  ## N, % missing in original data
  nmiss.org <- sum(is.na(tbi.daily.icu[,vname]))
  pctmiss.org <- round((nmiss.org / nrow(tbi.daily.icu))*100)
  
  ## N, % of missing imputed
  nimp <- sum(is.na(tbi.daily.icu[,vname]) & !is.na(tbi.daily.icu[,vname.imp]))
  pctimp <- round((nimp / nmiss.org)*100)
  
  ## N, % of patient-days still missing after imputation
  nmiss.imp <- sum(is.na(tbi.daily.icu[,vname.imp]))
  pctmiss.imp <- round((nmiss.imp / nrow(tbi.daily.icu))*100)
  
  c("% (N) Missing,\nOriginal Data" =
      paste0(pctmiss.org, '% (', format(nmiss.org, big.mark = ','), ')'),
    "% (N) of Missing\nValues Imputed" = paste0(pctimp, '% (', format(nimp, big.mark = ','), ')'),
    "% (N) Still Missing\nAfter Imputation" =
      paste0(pctmiss.imp, '% (', format(nmiss.imp, big.mark = ','), ')'))
}))

rownames(clinical.imp.npct.missing) <- clinical.imp.covars

## How many records had missing ICP / ICP > 120 in original data?
n.icpmiss <- sum(is.na(tbi.daily.icu$max.icp))
pct.icpmiss <- round((n.icpmiss / nrow(tbi.daily.icu))*100)
npct.icpmiss <- paste0(pct.icpmiss, '% (', format(n.icpmiss, big.mark = ','), ')')

n.icp120 <- sum(tbi.daily.icu$max.icp > 120, na.rm = TRUE)
pct.icp120 <- round((n.icp120 / nrow(tbi.daily.icu))*100, digits = 2)
npct.icp120 <- paste0(pct.icp120, '% (', format(n.icp120, big.mark = ','), ')')

```

#### `r table_nums("clinical_imputation")`
Percentages for original and post-imputation missingness are out of the `r nrow(tbi.daily.icu)` in-hospital patient-days among those patients eligible for inclusion in our analyses.

```{r print_clinical_imp, results = 'asis'}
panderOptions('table.emphasize.rownames', FALSE)
panderOptions('keep.line.breaks', TRUE)
pander(clinical.imp.npct.missing, keep.line.breaks = TRUE)

```

Additionally:

- The liver component of the SOFA score was considered to be normal if no bilirubin was measured.
- Missing maximum ICP was assumed to be normal, and assigned a random value from a uniform distribution ranging from 0 to 20 (normal range; imputed values were rounded, to result in integer scores). Maximum ICP > 120 was truncated to 120. In the original data, `r npct.icpmiss` records were missing ICP and assigned a random normal-range value, and `r npct.icp120` had ICP > 120.
- When calculating final full and modified SOFA scores, components which were still missing after
clinical imputation were assumed to be normal (component score = 0). For example, if a patient was hospitalized for five days and never had creatinine measured, that patient would be assumed to have no renal dysfunction during this hospitalization and would have SOFA renal scores of 0 on all five days (though the overall SOFA score would depend on the other components). This also means that any
patient-day with no SOFA component data has a SOFA score of 0.
- If no dose was recorded for medications or blood products on a given day, we assume the patient received no drug/product, and the dose is considered to be 0.
- If no maximum motor score was available on Days 00 - 02, the *baseline* maximum motor score was considered to be normal and assigned a value of 6.

There is still missing data after these imputation rules are implemented; for example, if a patient's glucose was never measured, there was never a value to carry forward or backward. Specific
amounts of missingness and strategies for handling it will be detailed separately for each analysis.

# Mortality Outcomes
To identify potential risk factors for both in-hospital and three-year mortality among this cohort,
we will use Cox proportional hazards regression with both baseline and time-dependent covariates.

## Model Covariates
We will include the following covariates in both models (reference levels for categorical variables are listed first):

- Baseline
    - Age at admission
    - Gender *(`r paste(levels(tbi.oneobs.icu$gender), collapse = '; ')`)*
    - Insurance type *(`r paste(levels(tbi.oneobs.icu$insurance.code), collapse = '; ')`)*
    - Marshall Class equivalent *(`r paste(levels(tbi.oneobs.icu$pt.marshall), collapse = '; ')`)*
    - Cerebral subarachnoid hemorrhage (SAH) *(`r paste(levels(tbi.oneobs.icu$pt.cerebral.na), collapse = '; ')`)*
    - Injurity Severity Score (ISS)
    - CPR *(`r paste(levels(tbi.oneobs.icu$cpr.yn), collapse = '; ')`)*
- Daily In-Hospital (all per 24h)
    - Maximum motor score
    - Pupil reactivity *(`r paste(levels(tbi.daily.icu$pupil.react.imp), collapse = '; ')`)*
    - Minimum glucose
    - Minimum hemoglobin
    - Minimum sodium
    - Mental status *(`r paste(levels(tbi.daily.icu$mental.status), collapse = '; ')`)*
    - Modified SOFA score (excluding CNS component)
    - Maximum ICP score, dichotomous *(`r paste(levels(tbi.daily.icu$max.icp.dich), collapse = '; ')`)*
    - 24-hour doses of medications: all will be cube root transformed to mitigate the influence of extremely high values
        - Opioids (hydromorphone, morphine, hydrocodone, methadone, remifentanil, and fentanyl; converted to fentanyl equivalents); allowed to be nonlinear
        - Benzodiazepines (lorazepam, diazepam, alprazolam, clonazepine, and midazolam; all converted to midazolam equivalents); allowed to be nonlinear
        - Antipsychotics (olanzapine, quetiapine, risperidone, ziprasidone, and haloperidol; all converted to haloperidol equivalents); forced to be linear
        - Beta-blockers (propranolol, labetalol, esmolol, and metoprolol; all converted to metoprolol equivalents); allowed to be nonlinear
        - Propofol; forced to be linear
        - Clonidine; forced to be linear
        - Dexmedetomidine; had to dichotomize *(`r paste(levels(tbi.daily.icu$any.dex), collapse = '; ')`)* due to high proportion of 0 values and sparse non-zero values
    - 24-hour units of blood products:
        - PRBC *(`r paste(levels(tbi.daily.icu$any.prbc), collapse = '; ')`)*
        - Plasma, platelets, and/or cryo *(`r paste(levels(tbi.daily.icu$any.plasmaplt), collapse = '; ')`)*
- For 3-year mortality model only:
    - Discharge disposition *(`r paste(levels(tbi.oneobs.icu$disposition.comb), collapse = '; ')`); note that LTAC, nursing care and transfers were combined into a single category*
    - Days on mechanical ventilation
    - Length of hospital stay

The following covariates were considered for inclusion, but changed or excluded as follows:

- Pentobarbital dose was originally slated as a covariate, but because there was so little pentobarbital use in our cohort, this covariate would only create problems while adding essentially
no information. See `r figure_nums('dailydrughist', display = 'cite')`.
- Plasma, platelets, and cryo were originally slated to be included as continuous units given;
however, because so few of these products were used (see
`r figure_nums('dailydrughist', display = 'cite')`), these were combined into a dichotomous yes/no
variable. Similarly, we had to dichotomize PRBC into given vs not given, rather than using the actual units.

Due to the amount of missingness in our data but also the complexity of performing multiple
imputation with both baseline (time-constant) and daily (time-varying) covariates, we will include
in these models only eligible patients with complete baseline data, and will use multiple imputation
to handle missing daily data. Patient exclusions and missingness will be detailed for each model.

## In-Hospital Mortality
```{r mort_inhosp_missing}
## -- Lists of covariates for mortality models -----------------------------------------------------
mortality.baseline.covars <- c('age', 'gender', 'insurance.code', 'pt.marshall', 'pt.cerebral.na',
                               'iss', 'cpr.yn')
mortality.daily.covars <- c('max.motor.imp', 'pupil.react.imp', 'min.glucose.imp',
                            'min.hemoglobin.imp', 'min.sodium.imp', 'mental.status',
                            'sofa.mod.nanormal.imp', 'max.icp.imp', 'max.icp.dich',
                            'tot.opioid.cube', 'tot.benzo.cube', 'tot.antipsyc.cube',
                            'tot.betablock.cube', 'tot.propofol.cube', 'any.dex', 'tot.clonid.cube',
                            'any.prbc', 'any.plasmaplt')
mortality.3yr.covars <- c('disposition.comb', 'vent.days', 'los')

## How many patients are missing *any* of these baseline variables?
tbi.oneobs.icu$include.mort.inhosp <-
  rowSums(is.na(tbi.oneobs.icu[,mortality.baseline.covars])) == 0
n.exc.mort.inhosp <- sum(!tbi.oneobs.icu$include.mort.inhosp)

## MRNs of patients included in mortality models
pts.inc.mort.inhosp <- unique(subset(tbi.oneobs.icu, include.mort.inhosp)$mrn)

mort.inhosp.baseline.missing <-
  as.data.frame(do.call(rbind,
                        lapply(mortality.baseline.covars,
                               FUN = function(vname){
                                 nmiss <- sum(is.na(tbi.oneobs.icu[,vname]))
                                 pctall.miss <- round((nmiss / length(pts.inc))*100, 2)
                                 pctexc.miss <- round((nmiss / n.exc.mort.inhosp)*100, 0)
                                 c(nmiss, pctall.miss, pctexc.miss)
                               })))
mort.inhosp.baseline.missing <- cbind(mortality.baseline.covars, mort.inhosp.baseline.missing)
names(mort.inhosp.baseline.missing) <- c('Covariate',
                                         'N Missing Covariate',
                                         '% Eligible Patients',
                                         '% Excluded Patients')
mort.inhosp.baseline.missing <- mort.inhosp.baseline.missing[mort.inhosp.baseline.missing[,2] > 0,]
rownames(mort.inhosp.baseline.missing) <- NULL

## Describe missingness among patient-days included in in-hospital mortality model
mort.inhosp.daily.missing <- tbi.daily.icu %>%
  filter(mrn %in% pts.inc.mort.inhosp) %>%
  select(one_of(mortality.daily.covars)) %>%
  missingInDataFrame() %>%
  filter(nmiss > 0)
rownames(mort.inhosp.daily.missing) <- NULL

```

### Patient Inclusion and Missing Data
Out of `r length(pts.inc)` patients eligible to be included in the in-hospital mortality model, `r n.exc.mort.inhosp` are missing one or more baseline covariates and will be excluded, leaving **`r length(pts.inc.mort.inhosp)`** patients included. `r table_nums("mort_inhosp_missing_baseline", display = 'cite')` details how many otherwise eligible patients are missing which baseline covariates.

#### `r table_nums("mort_inhosp_missing_baseline")`
```{r print_mort_inhosp_missing_baseline, results = 'asis'}
pandoc.table(mort.inhosp.baseline.missing, justify = c('left', 'right', 'right', 'right'))

```

Among those patients included, we did have some missing daily data which is handled using multiple
imputation. `r table_nums("mort_inhosp_missing_daily", display = 'cite')` details the percentage
and number of in-hospital patient-days among the `r length(pts.inc.mort.inhosp)` patients included
in the in-hospital mortality model with each variable missing.

#### `r table_nums("mort_inhosp_missing_daily")`
```{r print_mort_inhosp_missing_daily, results = 'asis'}
pandoc.table(mort.inhosp.daily.missing[,c('Variable', '% (N)')], justify = c('left', 'right'))

```

```{r mort_inhosp_datamgmt}
## Functions to set missing values to/from -9999 so they don't kicked out of timevarying.data()
set.na.9999 <- function(x){ ifelse(is.na(x), -9999, x) }
set.backto.na <- function(x){ ifelse(x == -9999, NA, x) }

## -- Create data set for in-hospital mortality model ----------------------------------------------
## Baseline information
base.mort.inhosp <- tbi.oneobs.icu %>%
  filter(include.mort.inhosp) %>%
  select(mrn, age, gender, insurance.code, iss, cpr.yn, pt.marshall, pt.cerebral.na, hosp.death,
         time.death.dc)

## Daily data
daily.mort.inhosp.org <- tbi.daily.icu %>%
  filter(mrn %in% pts.inc.mort.inhosp) %>%
  ## We have missingness for lab values, mental status, pupil reactivity, max motor. By default,
  ## function for time-varying data sets will delete any row with missing data; we do not want this,
  ## because we want to impute missing values later. Temporarily set all missings to -9999 (this
  ## will make factors numeric; will need to fix later).
  mutate(max.motor.imp = set.na.9999(max.motor.imp),
         pupil.react.imp = set.na.9999(as.numeric(pupil.react.imp)),
         min.glucose.imp = set.na.9999(min.glucose.imp),
         min.hemoglobin.imp = set.na.9999(min.hemoglobin.imp),
         min.sodium.imp = set.na.9999(min.sodium.imp),
         mental.status = set.na.9999(as.numeric(mental.status))) %>%
  select(mrn, study.day, max.motor.imp, pupil.react.imp, min.glucose.imp, min.hemoglobin.imp,
         min.sodium.imp, mental.status, sofa.mod.nanormal.imp, max.icp.imp, max.icp.dich,
         tot.opioid.cube, tot.benzo.cube, tot.antipsyc.cube, tot.betablock.cube, tot.propofol.cube,
         any.dex, tot.clonid.cube, any.prbc, any.plasmaplt)

## Create beginning time-varying data set
tv.mort.inhosp <- timevarying.data(idvar = 'mrn',
                                   recvar = 'study.day',
                                   org.data = daily.mort.inhosp.org,
                                   time.var = 'time.death.dc',
                                   event.var = 'hosp.death',
                                   event.string = 'Yes',
                                   data.set = tbi.oneobs.icu,
                                   out.strings = c('Alive through today', 'Died today'))

modeldata.mort.inhosp <- tv.mort.inhosp %>%
  ## Replace -9999s with NAs, refactor applicable variables
  mutate(max.motor.imp = set.backto.na(max.motor.imp),
         pupil.react.imp = factor(set.backto.na(pupil.react.imp),
                                  levels = 1:3, labels = levels(tbi.daily$pupil.react.imp)),
         min.glucose.imp = set.backto.na(min.glucose.imp),
         min.hemoglobin.imp = set.backto.na(min.hemoglobin.imp),
         min.sodium.imp = set.backto.na(min.sodium.imp),
         mental.status = factor(set.backto.na(mental.status),
                                levels = 1:3, labels = levels(tbi.daily$mental.status))) %>%
  ## Add on baseline variables
  left_join(base.mort.inhosp, ., by = 'mrn')

## For some reason, labels for some variables are not preserved. Add them again. Sigh.
label(modeldata.mort.inhosp$max.motor.imp) <- label(tbi.daily$max.motor.imp)
label(modeldata.mort.inhosp$pupil.react.imp) <- label(tbi.daily$pupil.react.imp)
label(modeldata.mort.inhosp$min.glucose.imp) <- label(tbi.daily$min.glucose.imp)
label(modeldata.mort.inhosp$min.hemoglobin.imp) <- label(tbi.daily$min.hemoglobin.imp)
label(modeldata.mort.inhosp$min.sodium.imp) <- label(tbi.daily$min.sodium.imp)
label(modeldata.mort.inhosp$mental.status) <- label(tbi.daily$mental.status)
label(modeldata.mort.inhosp$max.icp.dich) <- label(tbi.daily$max.icp.dich)
label(modeldata.mort.inhosp$any.dex) <- label(tbi.daily$any.dex)
label(modeldata.mort.inhosp$any.prbc) <- label(tbi.daily$any.prbc)
label(modeldata.mort.inhosp$any.plasmaplt) <- label(tbi.daily$any.plasmaplt)
## Shorten super long label for modified SOFA
label(modeldata.mort.inhosp$sofa.mod.nanormal.imp) <- 'Modified SOFA (missing component = 0)'

```

```{r mort_inhosp_fitmod}
## -- Imputation for in-hospital mortality ---------------------------------------------------------
set.seed(56)
areg.mort.inhosp <- aregImpute(~ age + gender + insurance.code + iss + cpr.yn + pt.marshall +
                                 pt.cerebral.na + hosp.death + I(max.motor.imp) + pupil.react.imp +
                                 min.glucose.imp + min.hemoglobin.imp + min.sodium.imp +
                                 mental.status + sofa.mod.nanormal.imp + max.icp.dich +
                                 tot.opioid.cube + tot.benzo.cube + tot.antipsyc.cube +
                                 tot.betablock.cube + tot.propofol.cube + any.dex +
                                 tot.clonid.cube + any.prbc + any.plasmaplt + start.day,
                               data = modeldata.mort.inhosp,
                               n.impute = 5, burnin = 3)

## -- Fit model for in-hospital mortality ----------------------------------------------------------
Surv.mort.inhosp <- with(modeldata.mort.inhosp, Surv(time = start.day,
                                                     time2 = stop.day,
                                                     event = as.numeric(had.event)))

mod.mort.inhosp <- fit.mult.impute(Surv.mort.inhosp ~ rcs(age, 4) + gender + insurance.code +
                                     rcs(iss, 4) + cpr.yn + pt.marshall + pt.cerebral.na +
                                     max.motor.imp + pupil.react.imp + rcs(min.glucose.imp, 4) +
                                     rcs(min.hemoglobin.imp, 4) + rcs(min.sodium.imp, 4) +
                                     mental.status + rcs(sofa.mod.nanormal.imp, 4) +
                                     max.icp.dich +
                                     ## Drug doses with enough variability to include w/ splines
                                     rcs(tot.opioid.cube, 4) + rcs(tot.benzo.cube, 4) +
                                     rcs(tot.betablock.cube, 4) +
                                     ## 3 drugs have too many 0s + otherwise sparse data,
                                     ## can't fit splines
                                     tot.antipsyc.cube + tot.propofol.cube + tot.clonid.cube +
                                     ## Dex and blood products have too many 0s + wide range;
                                     ## dichotomize
                                     any.dex + any.prbc + any.plasmaplt,
                                   fitter = cph,
                                   xtrans = areg.mort.inhosp,
                                   data = modeldata.mort.inhosp,
                                   x = TRUE, y = TRUE)

```

### Model Assumptions
`r figure_nums('mort_inhosp_zph', display = 'cite')` graphically examines the proportional hazards
assumption (that beta(t) is roughly constant over time; in other words, we want to see flat lines).

#### `r figure_nums('mort_inhosp_zph')`
```{r mort_inhosp_checkph, results='asis'}
## -- Check proportional hazard assumption ---------------------------------------------------------
zph.mort.inhosp <- cox.zph(mod.mort.inhosp, transform = 'rank')

par(mfrow = c(1, 2))
plot(zph.mort.inhosp, col = 'red', lwd = 2)
par(mfrow = c(1, 1))

```

### Model Results
```{r mort_inhosp_results}
dd.inhosp <- datadist(modeldata.mort.inhosp, adjto.cat = 'first')
options(datadist = 'dd.inhosp')
results.mort.inhosp <- model.results(mod.mort.inhosp,
                                     data.set = modeldata.mort.inhosp,
                                     print.format = 'plain')

```

```{r print_mort_inhosp_results, results = 'asis'}
pandoc.table(results.mort.inhosp, justify = 'lrrrrrr', style = 'rmarkdown', split.tables = 800)
```

# Software Details
`r devtools::session_info()$platform$version` was used for all analyses. `r table_nums('package_info', display = 'cite')` shows all add-on packages loaded.

```{r technical, results = 'asis'}
pander(devtools::session_info()$packages)
```
